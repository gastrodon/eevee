From 68f3139826b53dcc3d497610e23e3239b3934dcc Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Sat, 1 Nov 2025 16:52:55 +0000
Subject: [PATCH 2/8] Optimize reproduce_with with single-pass max finding

Replace fold-based max finding with explicit loop for better performance. Pre-allocate exact capacity needed for nodes vector.
---
 src/genome/recurrent.rs | 17 ++++++++++++-----
 1 file changed, 12 insertions(+), 5 deletions(-)

diff --git a/src/genome/recurrent.rs b/src/genome/recurrent.rs
index 19bf086..ca18555 100644
--- a/src/genome/recurrent.rs
+++ b/src/genome/recurrent.rs
@@ -111,11 +111,18 @@ impl<C: Connection> Genome<C> for Recurrent<C> {
 
     fn reproduce_with(&self, other: &Self, self_fit: Ordering, rng: &mut impl RngCore) -> Self {
         let connections = crossover(&self.connections, &other.connections, self_fit, rng);
-        let nodes_size = connections
-            .iter()
-            .fold(0, |prev, c| max(prev, max(c.from(), c.to())));
+        
+        // Find max node index in one pass
+        let mut nodes_size = 0;
+        for c in &connections {
+            nodes_size = max(nodes_size, max(c.from(), c.to()));
+        }
 
-        let mut nodes = Vec::with_capacity(self.sensory + self.action + 1);
+        // Pre-allocate exact capacity needed
+        let total_nodes = max(nodes_size + 1, self.sensory + self.action + 1);
+        let mut nodes = Vec::with_capacity(total_nodes);
+        
+        // Build nodes vector efficiently
         for _ in 0..self.sensory {
             nodes.push(NodeKind::Sensory);
         }
@@ -123,7 +130,7 @@ impl<C: Connection> Genome<C> for Recurrent<C> {
             nodes.push(NodeKind::Action);
         }
         nodes.push(NodeKind::Static);
-        for _ in self.sensory + self.action..nodes_size {
+        for _ in self.sensory + self.action + 1..total_nodes {
             nodes.push(NodeKind::Internal);
         }
 
-- 
2.51.2

